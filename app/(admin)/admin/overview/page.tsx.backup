import { getAdminDashboardStats, getAllUsersStats } from '@/lib/services/adminStatsService';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { 
  Users, 
  TrendingUp, 
  Activity, 
  DollarSign, 
  Target, 
  CheckCircle,
  Calendar,
  Award,
  AlertTriangle,
  TrendingDown,
  Zap
} from 'lucide-react';
import { UserComparisonChart } from '@/components/charts/UserComparisonChart';

export default async function AdminDashboardPage() {
  const stats = await getAdminDashboardStats();
  const allUsers = await getAllUsersStats();

  // Coaching insights
  const topPerformer = allUsers[0];
  const lowPerformer = allUsers[allUsers.length - 1];
  const avgWinRate = stats.avgWinRateAllUsers;
  const avgSopRate = stats.avgSopRateAllUsers;

  // Identify traders needing attention
  const needsAttention = allUsers.filter(u => u.winRate < 50 || u.sopRate < 65);
  const highPotential = allUsers.filter(u => u.sopRate >= 80 && u.winRate >= 60);
  const inconsistent = allUsers.filter(u => u.winRate < 55 && u.sopRate >= 75);

  const coachingStats = [
    {
      title: 'Total Traders',
      value: stats.totalUsers,
      icon: Users,
      color: 'text-blue-600',
      bgColor: 'bg-blue-100',
      subtitle: `${stats.activeUsersThisMonth} active this month`,
    },
    {
      title: 'Top Performer',
      value: topPerformer ? `${topPerformer.winRate.toFixed(1)}%` : 'N/A',
      icon: Award,
      color: 'text-green-600',
      bgColor: 'bg-green-100',
      subtitle: topPerformer ? topPerformer.userName : 'No data',
    },
    {
      title: 'Needs Attention',
      value: needsAttention.length,
      icon: AlertTriangle,
      color: 'text-red-600',
      bgColor: 'bg-red-100',
      subtitle: `${((needsAttention.length / stats.totalUsers) * 100).toFixed(0)}% of traders`,
    },
    {
      title: 'High Potential',
      value: highPotential.length,
      icon: Zap,
      color: 'text-purple-600',
      bgColor: 'bg-purple-100',
      subtitle: 'Great discipline',
    },
    {
      title: 'Team Avg Win Rate',
      value: `${stats.avgWinRateAllUsers.toFixed(1)}%`,
      icon: Target,
      color: stats.avgWinRateAllUsers >= 55 ? 'text-green-600' : 'text-orange-600',
      bgColor: stats.avgWinRateAllUsers >= 55 ? 'bg-green-100' : 'bg-orange-100',
      subtitle: `Benchmark: 55%`,
    },
    {
      title: 'Team Avg SOP Rate',
      value: `${stats.avgSopRateAllUsers.toFixed(1)}%`,
      icon: CheckCircle,
      color: stats.avgSopRateAllUsers >= 75 ? 'text-green-600' : 'text-orange-600',
      bgColor: stats.avgSopRateAllUsers >= 75 ? 'bg-green-100' : 'bg-orange-100',
      subtitle: `Benchmark: 75%`,
    },
    {
      title: 'Total Trades',
      value: stats.totalTradesThisMonth.toLocaleString(),
      icon: Activity,
      color: 'text-purple-600',
      bgColor: 'bg-purple-100',
      subtitle: `This month`,
    },
    {
      title: 'Team P&L',
      value: `$${stats.totalProfitLossAllUsers >= 0 ? '+' : ''}${stats.totalProfitLossAllUsers.toFixed(0)}`,
      icon: DollarSign,
      color: stats.totalProfitLossAllUsers >= 0 ? 'text-green-600' : 'text-red-600',
      bgColor: stats.totalProfitLossAllUsers >= 0 ? 'bg-green-100' : 'bg-red-100',
      subtitle: 'All time',
    },
  ];

  return (
    <div className="space-y-8">
      {/* Page Header */}
      <div>
        <h1 className="text-3xl font-bold text-gray-900">Coaching Dashboard</h1>
        <p className="mt-2 text-sm text-gray-600">
          Performance monitoring, benchmarking, and trader development insights
        </p>
      </div>

      {/* Coaching Stats Grid */}
      <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
        {coachingStats.map((stat) => {
          const Icon = stat.icon;
          return (
            <Card key={stat.title}>
              <CardHeader className="flex flex-row items-center justify-between pb-2">
                <div className="flex-1">
                  <CardTitle className="text-sm font-medium text-gray-600">
                    {stat.title}
                  </CardTitle>
                  <div className="text-2xl font-bold text-gray-900 mt-1">{stat.value}</div>
                  <p className="text-xs text-gray-500 mt-1">{stat.subtitle}</p>
                </div>
                <div className={`rounded-full p-2 ${stat.bgColor}`}>
                  <Icon className={`h-4 w-4 ${stat.color}`} />
                </div>
              </CardHeader>
            </Card>
          );
        })}
      </div>

      {/* Coaching Priorities */}
      {needsAttention.length > 0 && (
        <Card className="border-red-200 bg-red-50">
          <CardHeader>
            <div className="flex items-center gap-2">
              <AlertTriangle className="h-5 w-5 text-red-600" />
              <CardTitle className="text-red-900">Priority: Traders Needing Immediate Attention</CardTitle>
            </div>
            <p className="text-sm text-red-700">
              These traders have win rates below 50% or SOP compliance below 65% - schedule coaching sessions
            </p>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-red-200">
                <thead>
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-medium text-red-800 uppercase">Name</th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-red-800 uppercase">Win Rate</th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-red-800 uppercase">SOP Rate</th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-red-800 uppercase">P&L</th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-red-800 uppercase">Action</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-red-100">
                  {needsAttention.map((user) => (
                    <tr key={user.userId}>
                      <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                        {user.userName}
                      </td>
                      <td className="px-4 py-3 whitespace-nowrap">
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                          {user.winRate.toFixed(1)}% {user.winRate < avgWinRate ? '‚Üì' : '‚Üë'}
                        </span>
                      </td>
                      <td className="px-4 py-3 whitespace-nowrap">
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                          {user.sopRate.toFixed(1)}% {user.sopRate < avgSopRate ? '‚Üì' : '‚Üë'}
                        </span>
                      </td>
                      <td className="px-4 py-3 whitespace-nowrap text-sm">
                        <span className={user.netProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'}>
                          ${user.netProfitLoss >= 0 ? '+' : ''}{user.netProfitLoss.toFixed(0)}
                        </span>
                      </td>
                      <td className="px-4 py-3 whitespace-nowrap text-xs">
                        {user.winRate < 45 && <span className="text-red-600 font-medium">Urgent: Risk Management</span>}
                        {user.winRate >= 45 && user.sopRate < 65 && <span className="text-orange-600 font-medium">Focus: Discipline</span>}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Performance Leaderboard */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>Performance Leaderboard</CardTitle>
              <p className="text-sm text-gray-600 mt-1">
                Ranked by win rate (primary) and SOP compliance (secondary)
              </p>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          {stats.topPerformers.length === 0 ? (
            <div className="text-center py-8 text-gray-500">
              No trading data available yet
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Rank
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Trader
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Trades
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Win Rate
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      SOP Rate
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      P&L
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Avg/Trade
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Status
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {allUsers.map((user) => {
                    const isAboveAvgWin = user.winRate > avgWinRate;
                    const isAboveAvgSop = user.sopRate > avgSopRate;
                    const isProfitable = user.netProfitLoss > 0;
                    
                    return (
                      <tr key={user.userId} className={`hover:bg-gray-50 ${
                        user.rank && user.rank <= 2 ? 'bg-green-50' : 
                        needsAttention.some(u => u.userId === user.userId) ? 'bg-red-50' : ''
                      }`}>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center">
                            {user.rank === 1 && <span className="text-2xl mr-2">ü•á</span>}
                            {user.rank === 2 && <span className="text-2xl mr-2">ü•à</span>}
                            {user.rank === 3 && <span className="text-2xl mr-2">ü•â</span>}
                            {(user.rank || 0) > 3 && (
                              <span className="text-sm font-medium text-gray-900">
                                #{user.rank}
                              </span>
                            )}
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm font-medium text-gray-900">
                            {user.userName}
                          </div>
                          <div className="text-sm text-gray-500">
                            Best: {user.bestSession}
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          <div>{user.totalTrades}</div>
                          <div className="text-xs text-gray-500">
                            {user.totalWins}W / {user.totalLosses}L
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center gap-2">
                            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                              user.winRate >= 65 ? 'bg-green-100 text-green-800' :
                              user.winRate >= 55 ? 'bg-blue-100 text-blue-800' :
                              user.winRate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                              'bg-red-100 text-red-800'
                            }`}>
                              {user.winRate.toFixed(1)}%
                            </span>
                            {isAboveAvgWin ? 
                              <TrendingUp className="h-3 w-3 text-green-600" /> : 
                              <TrendingDown className="h-3 w-3 text-red-600" />
                            }
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center gap-2">
                            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                              user.sopRate >= 85 ? 'bg-green-100 text-green-800' :
                              user.sopRate >= 75 ? 'bg-blue-100 text-blue-800' :
                              user.sopRate >= 65 ? 'bg-yellow-100 text-yellow-800' :
                              'bg-red-100 text-red-800'
                            }`}>
                              {user.sopRate.toFixed(1)}%
                            </span>
                            {isAboveAvgSop ? 
                              <CheckCircle className="h-3 w-3 text-green-600" /> : 
                              <AlertTriangle className="h-3 w-3 text-orange-600" />
                            }
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className={`text-sm font-medium ${
                            user.netProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'
                          }`}>
                            ${user.netProfitLoss >= 0 ? '+' : ''}{user.netProfitLoss.toFixed(0)}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                          ${user.avgProfitPerTrade.toFixed(2)}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-xs">
                          {user.rank && user.rank <= 2 && (
                            <span className="inline-flex items-center px-2 py-1 rounded-md bg-green-100 text-green-700 font-medium">
                              ‚≠ê Role Model
                            </span>
                          )}
                          {highPotential.some(u => u.userId === user.userId) && user.rank && user.rank > 2 && (
                            <span className="inline-flex items-center px-2 py-1 rounded-md bg-purple-100 text-purple-700 font-medium">
                              üíé High Potential
                            </span>
                          )}
                          {needsAttention.some(u => u.userId === user.userId) && (
                            <span className="inline-flex items-center px-2 py-1 rounded-md bg-red-100 text-red-700 font-medium">
                              ‚ö†Ô∏è Needs Help
                            </span>
                          )}
                          {inconsistent.some(u => u.userId === user.userId) && (
                            <span className="inline-flex items-center px-2 py-1 rounded-md bg-orange-100 text-orange-700 font-medium">
                              üìä Inconsistent
                            </span>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Comparative Analysis Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <UserComparisonChart
          metric="winRate"
          title="Win Rate Comparison"
          description="Who's winning more trades?"
        />
        <UserComparisonChart
          metric="sopRate"
          title="Discipline Comparison"
          description="Who's following the plan?"
        />
      </div>
      <div className="grid grid-cols-1">
        <UserComparisonChart
          metric="profitLoss"
          title="Profit/Loss Comparison"
          description="Who's making money?"
        />
      </div>
    </div>
  );
}

  const statCards = [
    {
      title: 'Total Users',
      value: stats.totalUsers,
      icon: Users,
      color: 'text-blue-600',
      bgColor: 'bg-blue-100',
    },
    {
      title: 'Active This Month',
      value: stats.activeUsersThisMonth,
      icon: Activity,
      color: 'text-green-600',
      bgColor: 'bg-green-100',
    },
    {
      title: 'Total Trades',
      value: stats.totalTradesAllTime.toLocaleString(),
      icon: TrendingUp,
      color: 'text-purple-600',
      bgColor: 'bg-purple-100',
    },
    {
      title: 'Trades This Month',
      value: stats.totalTradesThisMonth.toLocaleString(),
      icon: Calendar,
      color: 'text-orange-600',
      bgColor: 'bg-orange-100',
    },
    {
      title: 'Avg Win Rate',
      value: `${stats.avgWinRateAllUsers.toFixed(1)}%`,
      icon: Target,
      color: 'text-green-600',
      bgColor: 'bg-green-100',
    },
    {
      title: 'Avg SOP Rate',
      value: `${stats.avgSopRateAllUsers.toFixed(1)}%`,
      icon: CheckCircle,
      color: 'text-blue-600',
      bgColor: 'bg-blue-100',
    },
    {
      title: 'Total P&L',
      value: `$${stats.totalProfitLossAllUsers >= 0 ? '+' : ''}${stats.totalProfitLossAllUsers.toFixed(2)}`,
      icon: DollarSign,
      color: stats.totalProfitLossAllUsers >= 0 ? 'text-green-600' : 'text-red-600',
      bgColor: stats.totalProfitLossAllUsers >= 0 ? 'bg-green-100' : 'bg-red-100',
    },
  ];

  return (
    <div className="space-y-8">
      {/* Page Header */}
      <div>
        <h1 className="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
        <p className="mt-2 text-sm text-gray-600">
          System overview and top performer rankings
        </p>
      </div>

      {/* Stats Grid */}
      <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
        {statCards.map((stat) => {
          const Icon = stat.icon;
          return (
            <Card key={stat.title}>
              <CardHeader className="flex flex-row items-center justify-between pb-2">
                <CardTitle className="text-sm font-medium text-gray-600">
                  {stat.title}
                </CardTitle>
                <div className={`rounded-full p-2 ${stat.bgColor}`}>
                  <Icon className={`h-4 w-4 ${stat.color}`} />
                </div>
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold text-gray-900">{stat.value}</div>
              </CardContent>
            </Card>
          );
        })}
      </div>

      {/* Top Performers */}
      <Card>
        <CardHeader>
          <CardTitle>Top 5 Performers</CardTitle>
          <p className="text-sm text-gray-600">
            Ranked by win rate, then SOP rate
          </p>
        </CardHeader>
        <CardContent>
          {stats.topPerformers.length === 0 ? (
            <div className="text-center py-8 text-gray-500">
              No trading data available yet
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Rank
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      User
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Trades
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Win Rate
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      SOP Rate
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      P&L
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Best Session
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {stats.topPerformers.map((user) => (
                    <tr key={user.userId}>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center">
                          {user.rank === 1 && <span className="text-2xl mr-2">ü•á</span>}
                          {user.rank === 2 && <span className="text-2xl mr-2">ü•à</span>}
                          {user.rank === 3 && <span className="text-2xl mr-2">ü•â</span>}
                          {(user.rank || 0) > 3 && (
                            <span className="text-sm font-medium text-gray-900">
                              #{user.rank}
                            </span>
                          )}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm font-medium text-gray-900">
                          {user.userName}
                        </div>
                        <div className="text-sm text-gray-500">
                          {user.userEmail}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {user.totalTrades}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                          user.winRate >= 60 ? 'bg-green-100 text-green-800' :
                          user.winRate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {user.winRate.toFixed(1)}%
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                          user.sopRate >= 80 ? 'bg-green-100 text-green-800' :
                          user.sopRate >= 60 ? 'bg-yellow-100 text-yellow-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {user.sopRate.toFixed(1)}%
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`text-sm font-medium ${
                          user.netProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'
                        }`}>
                          ${user.netProfitLoss >= 0 ? '+' : ''}{user.netProfitLoss.toFixed(2)}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {user.bestSession || 'N/A'}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Recent Activity Chart */}
      {stats.recentActivity.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Recent Activity (Last 30 Days)</CardTitle>
            <p className="text-sm text-gray-600">
              Daily trades and active users
            </p>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Date
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Total Trades
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Active Users
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {stats.recentActivity.slice(-10).reverse().map((activity) => (
                    <tr key={activity.date}>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {new Date(activity.date).toLocaleDateString('en-US', {
                          month: 'short',
                          day: 'numeric',
                          year: 'numeric',
                        })}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {activity.totalTrades}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {activity.activeUsers}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      )}

      {/* User Comparison Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <UserComparisonChart
          metric="winRate"
          title="Win Rate Comparison"
          description="Top 10 users by win rate"
        />
        <UserComparisonChart
          metric="sopRate"
          title="SOP Rate Comparison"
          description="Top 10 users by SOP compliance"
        />
      </div>
      <div className="grid grid-cols-1">
        <UserComparisonChart
          metric="profitLoss"
          title="Profit/Loss Comparison"
          description="Top 10 users by total P&L"
        />
      </div>
    </div>
  );
}
